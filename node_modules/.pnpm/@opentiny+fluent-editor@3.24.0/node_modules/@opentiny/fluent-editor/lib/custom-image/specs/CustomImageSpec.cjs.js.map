{"version":3,"file":"CustomImageSpec.cjs.js","sources":["../../../../src/custom-image/specs/CustomImageSpec.ts"],"sourcesContent":["import { isInside } from '../../config/editor.utils'\r\nimport CustomResizeAction from '../actions/CustomResizeAction'\r\nimport DeleteAction from '../actions/DeleteAction'\r\nimport ImageSpec from './ImageSpec'\r\n\r\nexport class CustomImageSpec extends ImageSpec {\r\n  formatter\r\n  editorElem: HTMLElement | undefined\r\n  observer: any\r\n  oldRootScrollTop: any\r\n\r\n  constructor(formatter) {\r\n    super(formatter)\r\n    this.formatter = formatter\r\n    this.oldRootScrollTop = this.formatter.quill.root.scrollTop\r\n    this.editorElem = this.formatter.quill.container\r\n    if (this.formatter.quill.root === this.formatter.quill.scrollingContainer) {\r\n      this.formatter.quill.root.addEventListener('scroll', this.handleQuillRootScroll.bind(this))\r\n    }\r\n  }\r\n\r\n  handleQuillRootScroll() {\r\n    if (this.formatter.overlay) {\r\n      this.formatter.overlay.style.marginTop = `${this.oldRootScrollTop - this.formatter.quill.root.scrollTop}px`\r\n    }\r\n  }\r\n\r\n  init(): void {\r\n    this.editorElem.addEventListener('mouseover', this.imageMouseOver.bind(this))\r\n    this.editorElem.addEventListener('mouseout', this.imageMouseout)\r\n\r\n    super.init()\r\n  }\r\n\r\n  getActions() {\r\n    return [DeleteAction, CustomResizeAction]\r\n  }\r\n\r\n  imageMouseOver(event) {\r\n    const target = event.target\r\n    const isBlotFormatter = target?.classList?.contains('blot-formatter__overlay')\r\n    if (target.nodeName === 'IMG' || isBlotFormatter) {\r\n      // this.addImagePreviewOverlay(event);\r\n    }\r\n  }\r\n\r\n  imageMouseout = (event) => {\r\n    if (event.target.nodeName === 'IMG'\r\n      || event.target.classList.contains('blot-formatter__overlay')) {\r\n      const imgDom = event.target\r\n      if (!isInside(event, imgDom)) {\r\n        this.removeImagePreviewOverlay()\r\n      }\r\n    }\r\n  }\r\n\r\n  addImagePreviewOverlay(event) {\r\n    const target = event.target\r\n    const {\r\n      left: imgLeft,\r\n      width: imgWidth,\r\n    } = target.getBoundingClientRect()\r\n    // fix: 解决 ql-container 容器设置 calc(100vh - 180px) 这样的视窗相对单位时，滚动视窗导致图片相对视窗的 top 相应改变，从而导致图片预览按钮的位置显示错误\r\n    const imgTop = target.getBoundingClientRect().top + this.formatter.quill.container.scrollTop\r\n\r\n    const {\r\n      left: editorLeft,\r\n      top: editorTop,\r\n    } = event.currentTarget.getBoundingClientRect()\r\n\r\n    const imgRelativeLeft = imgLeft - editorLeft\r\n    const imgRelativeTop = imgTop - editorTop\r\n\r\n    const maxmizeWidth = 24\r\n    const maxmizePadding = 15\r\n    const previewLeft = imgRelativeLeft + imgWidth - maxmizeWidth - maxmizePadding\r\n    const previewTop = imgRelativeTop + maxmizePadding\r\n\r\n    const previewStyle = `\r\n        left: ${previewLeft}px;\r\n        top: ${previewTop}px;\r\n        width: ${maxmizeWidth}px;\r\n      `\r\n    const imageSrc = target.src || target.getAttribute('data-image')\r\n    const imageId = target.getAttribute('data-image-id')\r\n\r\n    const previewDom = event.currentTarget.querySelector('.image-preview__overlay')\r\n    if (!previewDom) {\r\n      event.currentTarget.insertAdjacentHTML('beforeend', `\r\n          <div class=\"image-preview__overlay\" style=\"${previewStyle}\">\r\n            <i class=\"icon-maxmize\" id=\"btn-image-preview\" data-image-id=\"${imageId}\"\r\n              data-image=\"${imageSrc}\"></i>\r\n          </div>\r\n        `)\r\n    }\r\n  }\r\n\r\n  removeImagePreviewOverlay() {\r\n    const previewDom = this.editorElem.querySelector('.image-preview__overlay')\r\n    if (previewDom) {\r\n      previewDom.parentNode.removeChild(previewDom)\r\n    }\r\n  }\r\n\r\n  onHide() {\r\n    this.removeImagePreviewOverlay()\r\n    super.onHide()\r\n  }\r\n\r\n  resetOverlayMarginTop() {\r\n    if (this.formatter.overlay) {\r\n      this.formatter.overlay.style.marginTop = '0px'\r\n    }\r\n  }\r\n\r\n  onClick = (event: MouseEvent) => {\r\n    const el = event.target\r\n    const isReadonly = this.formatter.quill.options.readOnly\r\n    if (!(el instanceof HTMLElement) || el.tagName !== 'IMG' || isReadonly) {\r\n      return\r\n    }\r\n\r\n    this.img = el\r\n    this.oldRootScrollTop = this.formatter.quill.root.scrollTop\r\n    this.resetOverlayMarginTop()\r\n    this.formatter.show(this)\r\n\r\n    // 通过图片dom获取图片选区用以复制，设置 current-select-img::selection 取消选区背景\r\n    const imageDom = this.formatter.currentSpec?.getTargetElement()\r\n    if (imageDom) {\r\n      imageDom.classList.add('current-select-img')\r\n      const quill = this.formatter.quill\r\n      const imgBlot = quill.scroll.find(this.img)\r\n      const index = quill.getIndex(imgBlot)\r\n      const len = imgBlot.length()\r\n      quill.setSelection(index, len)\r\n    }\r\n  }\r\n}\r\n"],"names":["ImageSpec","isInside","DeleteAction","CustomResizeAction"],"mappings":"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"}