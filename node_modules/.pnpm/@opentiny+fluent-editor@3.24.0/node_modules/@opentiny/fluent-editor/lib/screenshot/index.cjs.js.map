{"version":3,"file":"index.cjs.js","sources":["../../../src/screenshot/index.ts"],"sourcesContent":["import type html2canvas from 'html2canvas'\r\nimport type { Options as Html2CanvasOptions } from 'html2canvas'\r\nimport type Toolbar from 'quill/modules/toolbar'\r\nimport Quill from 'quill'\r\nimport { imgToBase64 } from '../utils/image'\r\nimport { lockScroll } from '../utils/scroll-lock'\r\n\r\nconst Delta = Quill.import('delta')\r\n\r\nexport type ScreenShotOptions = Partial<Html2CanvasOptions> & {\r\n  Html2Canvas: typeof html2canvas\r\n  beforeCreateCanvas: () => void | Promise<void>\r\n  beforeCreateImage: (canvas: HTMLCanvasElement) => HTMLCanvasElement | string | Promise<HTMLCanvasElement | string>\r\n}\r\ninterface ScreenShotOptionsInQuill {\r\n  quill: {\r\n    options: {\r\n      screenshot: Partial<ScreenShotOptions>\r\n    }\r\n  }\r\n}\r\n\r\nfunction resolveOptions(options: Partial<ScreenShotOptions>) {\r\n  return Object.assign({\r\n    // @ts-ignore\r\n    Html2Canvas: window.Html2Canvas,\r\n    useCORS: true,\r\n    scale: 1,\r\n    foreignObjectRendering: true,\r\n    beforeCreateImage: undefined,\r\n    beforeCreateCanvas: undefined,\r\n  }, options)\r\n}\r\n\r\nfunction init() {\r\n  const maskExits = document.querySelectorAll('.ql-screenshot-mask')\r\n  if (maskExits) {\r\n    maskExits.forEach(item => item && item.remove())\r\n  }\r\n  // 创建截图图层\r\n  const wrapper = document.createElement('div')\r\n  wrapper.classList.add('ql-screenshot-wrapper')\r\n  const mask = document.createElement('div')\r\n  mask.className = 'ql-screenshot-mask'\r\n  const cutter = document.createElement('div')\r\n  cutter.className = 'ql-screenshot-cutter'\r\n  const coordinate = document.createElement('p')\r\n  coordinate.className = 'ql-screenshot-coordinate'\r\n  cutter.appendChild(coordinate)\r\n  wrapper.appendChild(mask)\r\n  wrapper.appendChild(cutter)\r\n  document.body.appendChild(wrapper)\r\n  return { wrapper, mask, cutter, coordinate }\r\n}\r\n\r\nfunction findParentFixed(dom: HTMLElement) {\r\n  if (dom.tagName === 'BODY') return false\r\n  if (['fixed', 'sticky'].includes(dom.parentElement.style.position)) return true\r\n  return findParentFixed(dom.parentElement)\r\n}\r\nasync function renderImage(\r\n  Html2Canvas: typeof html2canvas,\r\n  html2canvasOptions: Partial<Html2CanvasOptions>,\r\n  rect: DOMRect,\r\n  options?: Omit<ScreenShotOptions, 'Html2Canvas' | keyof Html2CanvasOptions>,\r\n) {\r\n  if (options && options.beforeCreateCanvas) {\r\n    await options.beforeCreateCanvas()\r\n  }\r\n  const canvas: CanvasImageSource = await Html2Canvas(document.body, {\r\n    ...html2canvasOptions,\r\n    onclone: async (doc: Document, el: HTMLElement) => {\r\n      // find all fixed or sticky dom\r\n      const fixedDom = Array.from(doc.querySelectorAll('*[style*=\"position: fixed\"]')) as HTMLElement[]\r\n      const stickyDom = Array.from(doc.querySelectorAll('*[style*=\"position: sticky\"]')) as HTMLElement[]\r\n      const fixedDomList = new Set([...fixedDom, ...stickyDom])\r\n      for (const dom of fixedDomList) {\r\n        // if parent dom already has fixed or sticky style\r\n        // means that transform will be settle. skip\r\n        if (findParentFixed(dom)) continue\r\n        // use transform move to correct position\r\n        let x = 0\r\n        let y = 0\r\n        if (dom.style.top !== 'auto') {\r\n          y = window.scrollY\r\n        }\r\n        if (dom.style.left !== 'auto') {\r\n          x = window.scrollX\r\n        }\r\n        if (x !== 0 || y !== 0) {\r\n          dom.style.transform = `translate(${x}px, ${y}px)`\r\n        }\r\n      }\r\n\r\n      const imgs = doc.querySelectorAll('img')\r\n      const promises = Array.from(imgs).map(async (img) => {\r\n        img.src = await imgToBase64(img.src)\r\n      })\r\n      await Promise.all(promises)\r\n      html2canvasOptions.onclone && await html2canvasOptions.onclone(doc, el)\r\n    },\r\n  })\r\n  // 当前canvas为body全局截图，从当前截图中截取想要的部分重新绘制转成base64插入富文本\r\n  let cropCanvas: HTMLCanvasElement | string = document.createElement('canvas')\r\n  cropCanvas.width = rect.width\r\n  cropCanvas.height = rect.height\r\n  const cropCanvasCtx = cropCanvas.getContext('2d')\r\n  cropCanvasCtx.drawImage(\r\n    canvas,\r\n    rect.x + window.scrollX,\r\n    rect.y + window.scrollY,\r\n    rect.width,\r\n    rect.height,\r\n    0,\r\n    0,\r\n    rect.width,\r\n    rect.height,\r\n  )\r\n  if (options && options.beforeCreateImage) {\r\n    cropCanvas = await options.beforeCreateImage(cropCanvas)\r\n  }\r\n  return typeof cropCanvas === 'string' ? cropCanvas : cropCanvas.toDataURL()\r\n}\r\n\r\nexport function Screenshot(this: Toolbar & ScreenShotOptionsInQuill) {\r\n  this.quill.options.screenshot = resolveOptions(this.quill.options.screenshot)\r\n  const options = this.quill.options.screenshot\r\n  // @ts-ignore\r\n  const { Html2Canvas, beforeCreateImage, beforeCreateCanvas, ...html2CanvasOptions } = options\r\n  if (!Html2Canvas) {\r\n    throw new Error('ScreenShot module requires html2canvas. Please include the library on the page before FluentEditor.')\r\n  }\r\n  const range = this.quill.getSelection()\r\n  const { wrapper, mask, cutter, coordinate } = init()\r\n  const status: {\r\n    leftClickLockFlag: boolean\r\n    start?: {\r\n      x: number\r\n      y: number\r\n    }\r\n  } = {\r\n    leftClickLockFlag: false,\r\n    start: undefined,\r\n  }\r\n  const cleanLock = lockScroll()\r\n\r\n  const removeContextmenu = (event: Event) => {\r\n    event.preventDefault()\r\n    wrapper.remove()\r\n    cleanLock()\r\n    document.removeEventListener('contextmenu', removeContextmenu)\r\n  }\r\n  const afterShotCtrl = async (event: MouseEvent) => {\r\n    document.removeEventListener('mousedown', toggleRect)\r\n    const cutterRect = cutter.getBoundingClientRect()\r\n    const target = event.target as HTMLElement\r\n    wrapper.remove()\r\n    cleanLock()\r\n    if (target && target.className === 'ql-screenshot-confirm') {\r\n      const image = await renderImage(Html2Canvas, html2CanvasOptions, cutterRect, { beforeCreateCanvas, beforeCreateImage })\r\n\r\n      const delta = new Delta()\r\n        .retain(range.index)\r\n        .delete(range.length)\r\n        .insert({ image })\r\n      this.quill.updateContents(delta, Quill.sources.USER)\r\n      this.quill.setSelection(range.index + 1, Quill.sources.SILENT)\r\n    }\r\n    status.start = undefined\r\n  }\r\n  const drawRect = (event: MouseEvent) => {\r\n    // 通过鼠标移动描绘截图图层\r\n    const startX = status.start.x\r\n    const startY = status.start.y\r\n    const endX = event.clientX\r\n    const endY = event.clientY\r\n    const width = Math.abs(endX - startX)\r\n    const height = Math.abs(endY - startY)\r\n    const top = startY < endY ? startY : endY\r\n    const left = startX < endX ? startX : endX\r\n    const bottom = window.innerHeight - height - top\r\n    const right = window.innerWidth - width - left\r\n\r\n    const maskPath = `\r\n      linear-gradient(to top, #fff, #fff) top / 100% ${top}px,\r\n      linear-gradient(to bottom, #fff, #fff) bottom /100% ${bottom}px,\r\n      linear-gradient(to left, #fff, #fff) left / ${left}px 100%,\r\n      linear-gradient(to right, #fff, #fff) right / ${right}px 100%\r\n    `\r\n    Object.assign(cutter.style, {\r\n      width: `${width}px`,\r\n      height: `${height}px`,\r\n      left: `${left}px`,\r\n      top: `${top}px`,\r\n    })\r\n    Object.assign(mask.style, {\r\n      'mask': maskPath,\r\n      '-webkit-mask-repeat': 'no-repeat',\r\n    })\r\n    coordinate.textContent = `${width}, ${height}`\r\n  }\r\n  const toggleRect = (event: MouseEvent) => {\r\n    // 右键取消截图操作\r\n    if (event.button === 2) {\r\n      document.removeEventListener('mousemove', drawRect)\r\n      document.removeEventListener('mousedown', toggleRect)\r\n      document.addEventListener('contextmenu', removeContextmenu)\r\n      return\r\n    }\r\n    if (!status.leftClickLockFlag) {\r\n      if (status.start) {\r\n        // 如果有起点，则当前触发坐标为终点，移除监听事件并添加确认和取消按钮\r\n        document.removeEventListener('mousemove', drawRect)\r\n        const doneBtn = document.createElement('div')\r\n        doneBtn.innerHTML = `<div class=\"ql-screenshot-confirm\"></div><div class=\"ql-screenshot-cancel\"></div>`\r\n        doneBtn.className = 'ql-screenshot-done'\r\n        doneBtn.addEventListener('click', afterShotCtrl)\r\n        coordinate.remove()\r\n        cutter.appendChild(doneBtn)\r\n        status.leftClickLockFlag = true\r\n      }\r\n      else {\r\n        // 无起点则设置起点坐标，监听鼠标移动\r\n        status.start = { x: event.clientX, y: event.clientY }\r\n        document.addEventListener('mousemove', drawRect)\r\n      }\r\n    }\r\n  }\r\n  document.addEventListener('mousedown', toggleRect)\r\n}\r\nScreenshot.toolName = 'screenshot'\r\n"],"names":["imgToBase64","lockScroll","image"],"mappings":"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"}