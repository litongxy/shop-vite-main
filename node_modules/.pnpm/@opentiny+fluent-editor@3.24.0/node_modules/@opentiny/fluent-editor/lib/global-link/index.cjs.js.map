{"version":3,"file":"index.cjs.js","sources":["../../../src/global-link/index.ts"],"sourcesContent":["import Quill from 'quill'\r\nimport { getEventComposedPath } from '../config/editor.utils'\r\nimport CustomerWidgetLink from './formats/customer-widget-link'\r\nimport DocumentLink from './formats/doc-link'\r\nimport WikiLink from './formats/wiki-link'\r\nimport WorkItemLink from './formats/work-item-link'\r\n\r\nconst Module = Quill.imports['core/module']\r\nconst Delta = Quill.imports.delta\r\n\r\n// @dynamic\r\nclass GlobalLink extends Module {\r\n  open: boolean\r\n  wrap: any\r\n  panel: any\r\n  quill: any\r\n\r\n  static register() {\r\n    Quill.register('formats/wiki-link', WikiLink)\r\n    Quill.register('formats/doc-link', DocumentLink)\r\n    Quill.register('formats/work-item-link', WorkItemLink)\r\n    Quill.register('formats/customer-widget-link', CustomerWidgetLink)\r\n  }\r\n\r\n  constructor(quill, options) {\r\n    super(quill, options)\r\n    const toolbar = quill.getModule('toolbar')\r\n    this.open = false\r\n    this.panel = options.component\r\n    this.wrap = options.wrap\r\n    const globalLinkBtn = toolbar.container && toolbar.container.querySelector('.ql-global-link')\r\n    toolbar.addHandler('global-link', this.handleGlobalLinkButtonClick.bind(this))\r\n    quill.root.addEventListener('click', this.onEditorClick.bind(this))\r\n    document.body.addEventListener('click', (evt) => {\r\n      if (!this.wrap.contains(evt.target) && !(globalLinkBtn && globalLinkBtn.contains(evt.target))) {\r\n        this.open = false\r\n        this.wrap.classList.add('global-link-hide')\r\n      }\r\n    })\r\n    this.panel.wikiLink.subscribe(this.addWikiLink.bind(this))\r\n    this.panel.docLink.subscribe(this.addDocLink.bind(this))\r\n    this.panel.workItemLink.subscribe(this.addWorkItemLink.bind(this))\r\n    if (this.panel.close) {\r\n      this.panel.close.subscribe(this.closePanel.bind(this))\r\n    }\r\n  }\r\n\r\n  onEditorClick(evt: any) {\r\n    if (!evt.ctrlKey) return\r\n    const path = getEventComposedPath(evt)\r\n    if (!path || path.length <= 0) return\r\n    const linkNode = path.filter((node) => {\r\n      return node.classList && (node.classList.contains(WikiLink.className)\r\n        || node.classList.contains(DocumentLink.className)\r\n        || node.classList.contains(WorkItemLink.className))\r\n    })[0]\r\n\r\n    if (!linkNode) return\r\n\r\n    if (linkNode.classList.contains(WikiLink.className)) {\r\n      this.handleLinkClick(linkNode)\r\n    }\r\n    else if (linkNode.classList.contains(DocumentLink.className)) {\r\n      this.handleLinkClick(linkNode)\r\n    }\r\n    else if (linkNode.classList.contains(WorkItemLink.className)) {\r\n      const tableRow = path.filter((node) => {\r\n        return node.tagName && node.tagName.toUpperCase() === 'TR'\r\n      })[0]\r\n\r\n      if (tableRow) {\r\n        this.handleLinkClick(tableRow)\r\n      }\r\n    }\r\n  }\r\n\r\n  handleLinkClick(linkNode) {\r\n    const href = linkNode.getAttribute('href')\r\n    if (href) {\r\n      window.open(href)\r\n    }\r\n  }\r\n\r\n  handleGlobalLinkButtonClick(_value) {\r\n    this.open = !this.open\r\n    this.triggerPanel()\r\n  }\r\n\r\n  triggerPanel() {\r\n    if (this.open) {\r\n      this.wrap.classList.remove('global-link-hide')\r\n    }\r\n    else {\r\n      this.wrap.classList.add('global-link-hide')\r\n    }\r\n  }\r\n\r\n  addWikiLink(wikiData) {\r\n    const index = this.quill.getSelection(true).index\r\n    const arr: { link: any, text: any } [] = []\r\n    const delta = arr.reduce.call(wikiData, (op: any, wiki) => {\r\n      op.insert({\r\n        [WikiLink.blotName]: {\r\n          link: wiki.link,\r\n          text: wiki.text,\r\n        },\r\n      })\r\n      return op\r\n    }, new Delta().retain(index))\r\n\r\n    this.quill.updateContents(delta, Quill.sources.USER)\r\n    this.quill.setSelection(index + 1, Quill.sources.USER)\r\n    if (this.panel.autoClose) {\r\n      this.closePanel()\r\n    }\r\n  }\r\n\r\n  addDocLink(docData) {\r\n    const index = this.quill.getSelection(true).index\r\n    const arr: { link: any, text: any, icon: any } [] = []\r\n    const delta = arr.reduce.call(docData, (op: any, doc) => {\r\n      op.insert({\r\n        [DocumentLink.blotName]: {\r\n          link: doc.link,\r\n          text: doc.text,\r\n          icon: doc.icon,\r\n        },\r\n      })\r\n      return op\r\n    }, new Delta().retain(index))\r\n\r\n    this.quill.updateContents(delta, Quill.sources.USER)\r\n    this.quill.setSelection(index + 1, Quill.sources.USER)\r\n    if (this.panel.autoClose) {\r\n      this.closePanel()\r\n    }\r\n  }\r\n\r\n  addWorkItemLink(workItemData) {\r\n    const index = this.quill.getSelection(true).index\r\n    const arr: { url: any, table: any } [] = []\r\n    const delta = arr.reduce.call(workItemData, (op: any, workItem) => {\r\n      op.insert({\r\n        [WorkItemLink.blotName]: {\r\n          link: workItem.url,\r\n          data: workItem.table,\r\n        },\r\n      })\r\n      return op\r\n    }, new Delta().retain(index))\r\n\r\n    this.quill.updateContents(delta, Quill.sources.USER)\r\n    this.quill.setSelection(index + 1, Quill.sources.USER)\r\n    if (this.panel.autoClose) {\r\n      this.closePanel()\r\n    }\r\n  }\r\n\r\n  closePanel() {\r\n    this.open = false\r\n    this.triggerPanel()\r\n  }\r\n}\r\n\r\nexport default GlobalLink\r\n"],"names":["WikiLink","DocumentLink","WorkItemLink","CustomerWidgetLink","getEventComposedPath"],"mappings":"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"}