{"version":3,"file":"index.cjs.js","sources":["../../../src/counter/index.ts"],"sourcesContent":["import type { FluentEditor } from 'src/fluent-editor'\r\nimport type { ICounterOption } from '../config/types'\r\nimport Quill from 'quill'\r\nimport { CHANGE_LANGUAGE_EVENT } from '../config'\r\n\r\nexport default class Counter {\r\n  container: HTMLDivElement\r\n  options: ICounterOption\r\n\r\n  constructor(public quill: FluentEditor, options: ICounterOption) {\r\n    this.options = this.resolveOptions(options)\r\n    this.container = quill.addContainer('ql-counter')\r\n    quill.on(Quill.events.TEXT_CHANGE, this.renderCount)\r\n    this.quill.on(CHANGE_LANGUAGE_EVENT, () => {\r\n      this.options = this.resolveOptions(options)\r\n      this.renderCount()\r\n    })\r\n    this.renderCount()\r\n  }\r\n\r\n  resolveOptions(options: ICounterOption) {\r\n    return Object.assign({\r\n      format: 'text',\r\n      unit: 'char',\r\n      template: this.quill.options.langText['counter-template'],\r\n      count: 500,\r\n    }, options)\r\n  }\r\n\r\n  renderCount = () => {\r\n    setTimeout(() => {\r\n      // @ts-ignore\r\n      const { format, count: totalCount, unit, template: counterTemplate, errorTemplate } = this.options\r\n      const count = this.getContentLength(format)\r\n      const restCount = totalCount - count\r\n      const countUnit = unit === 'char' ? this.quill.options.langText.char : this.quill.options.langText.word\r\n      let template: any = counterTemplate\r\n      if (typeof template === 'function') {\r\n        template = template(count, restCount)\r\n      }\r\n      const desc = template.replace('{{count}}', count)\r\n        .replace('{{totalCount}}', String(totalCount))\r\n        .replace('{{restCount}}', String(restCount))\r\n        .replace(/{{countUnit}}/g, countUnit)\r\n\r\n      let limitTemplate: any = errorTemplate || this.quill.options.langText['counter-limit-tips']\r\n      if (typeof limitTemplate === 'function') {\r\n        limitTemplate = limitTemplate(count, restCount)\r\n      }\r\n      const limitTips = limitTemplate.replace('{{countUnit}}', countUnit)\r\n      if (restCount < 0) {\r\n        this.container.innerHTML = errorTemplate ? limitTips : `<span style=\"color:red\">${limitTips}</span>`\r\n      }\r\n      else {\r\n        this.container.innerHTML = desc\r\n      }\r\n    })\r\n  }\r\n\r\n  getContentLength(format) {\r\n    let content = this.quill.getText()\r\n    if (format === 'html') {\r\n      let html = this.quill.root.innerHTML\r\n      // 编辑器初始时\r\n      if (html === '<p><br></p>' || html === '<div><br><div>') {\r\n        html = ''\r\n      }\r\n      content = html\r\n    }\r\n    const text = content.replace(/\\s/g, '').trim()\r\n    if (this.options.unit === 'word') {\r\n      return !content.trim() ? 0 : content.trim().split(/\\s+/).length\r\n    }\r\n    return text.length\r\n  }\r\n}\r\n"],"names":["CHANGE_LANGUAGE_EVENT"],"mappings":";;;;;AAKA,MAAqB,QAAQ;AAAA,EAI3B,YAAmB,OAAqB,SAAyB;AAA9C,SAAA,QAAA;AAoBnB,SAAA,cAAc,MAAM;AAClB,iBAAW,MAAM;AAET,cAAA,EAAE,QAAQ,OAAO,YAAY,MAAM,UAAU,iBAAiB,cAAc,IAAI,KAAK;AACrF,cAAA,QAAQ,KAAK,iBAAiB,MAAM;AAC1C,cAAM,YAAY,aAAa;AACzB,cAAA,YAAY,SAAS,SAAS,KAAK,MAAM,QAAQ,SAAS,OAAO,KAAK,MAAM,QAAQ,SAAS;AACnG,YAAI,WAAgB;AAChB,YAAA,OAAO,aAAa,YAAY;AACvB,qBAAA,SAAS,OAAO,SAAS;AAAA,QACtC;AACM,cAAA,OAAO,SAAS,QAAQ,aAAa,KAAK,EAC7C,QAAQ,kBAAkB,OAAO,UAAU,CAAC,EAC5C,QAAQ,iBAAiB,OAAO,SAAS,CAAC,EAC1C,QAAQ,kBAAkB,SAAS;AAEtC,YAAI,gBAAqB,iBAAiB,KAAK,MAAM,QAAQ,SAAS,oBAAoB;AACtF,YAAA,OAAO,kBAAkB,YAAY;AACvB,0BAAA,cAAc,OAAO,SAAS;AAAA,QAChD;AACA,cAAM,YAAY,cAAc,QAAQ,iBAAiB,SAAS;AAClE,YAAI,YAAY,GAAG;AACjB,eAAK,UAAU,YAAY,gBAAgB,YAAY,2BAA2B,SAAS;AAAA,QAAA,OAExF;AACH,eAAK,UAAU,YAAY;AAAA,QAC7B;AAAA,MAAA,CACD;AAAA,IAAA;AA9CI,SAAA,UAAU,KAAK,eAAe,OAAO;AACrC,SAAA,YAAY,MAAM,aAAa,YAAY;AAChD,UAAM,GAAG,MAAM,OAAO,aAAa,KAAK,WAAW;AAC9C,SAAA,MAAM,GAAGA,cAAAA,uBAAuB,MAAM;AACpC,WAAA,UAAU,KAAK,eAAe,OAAO;AAC1C,WAAK,YAAY;AAAA,IAAA,CAClB;AACD,SAAK,YAAY;AAAA,EACnB;AAAA,EAEA,eAAe,SAAyB;AACtC,WAAO,OAAO,OAAO;AAAA,MACnB,QAAQ;AAAA,MACR,MAAM;AAAA,MACN,UAAU,KAAK,MAAM,QAAQ,SAAS,kBAAkB;AAAA,MACxD,OAAO;AAAA,OACN,OAAO;AAAA,EACZ;AAAA,EAgCA,iBAAiB,QAAQ;AACnB,QAAA,UAAU,KAAK,MAAM,QAAQ;AACjC,QAAI,WAAW,QAAQ;AACjB,UAAA,OAAO,KAAK,MAAM,KAAK;AAEvB,UAAA,SAAS,iBAAiB,SAAS,kBAAkB;AAChD,eAAA;AAAA,MACT;AACU,gBAAA;AAAA,IACZ;AACA,UAAM,OAAO,QAAQ,QAAQ,OAAO,EAAE,EAAE;AACpC,QAAA,KAAK,QAAQ,SAAS,QAAQ;AACzB,aAAA,CAAC,QAAQ,KAAS,IAAA,IAAI,QAAQ,KAAK,EAAE,MAAM,KAAK,EAAE;AAAA,IAC3D;AACA,WAAO,KAAK;AAAA,EACd;AACF;;"}