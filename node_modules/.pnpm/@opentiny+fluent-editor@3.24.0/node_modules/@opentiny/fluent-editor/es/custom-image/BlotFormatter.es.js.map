{"version":3,"file":"BlotFormatter.es.js","sources":["../../../src/custom-image/BlotFormatter.ts"],"sourcesContent":["import type Action from './actions/Action'\r\nimport type { Options } from './Options'\r\nimport type BlotSpec from './specs/BlotSpec'\r\nimport { merge as deepmerge } from 'lodash-es'\r\nimport Quill from 'quill'\r\nimport ImageBlot, { ImageContainerBlot } from './image'\r\nimport DefaultOptions from './Options'\r\nimport { CustomImageSpec } from './specs/CustomImageSpec'\r\n\r\nconst dontMerge = (_destination: Array<any>, source: Array<any>) => source\r\n\r\n// @dynamic\r\nexport default class BlotFormatter {\r\n  quill: any\r\n  options: Options\r\n  currentSpec: BlotSpec\r\n  specs: BlotSpec[]\r\n  overlay: HTMLElement\r\n  actions: Action[]\r\n  observer: any\r\n\r\n  static register() {\r\n    Quill.register('formats/image', ImageBlot, true)\r\n    Quill.register('formats/image-container', ImageContainerBlot, true)\r\n    Quill.register('modules/image-spec', CustomImageSpec, true)\r\n  }\r\n\r\n  constructor(quill: any, options: any = {}) {\r\n    this.quill = quill\r\n    this.options = deepmerge(DefaultOptions, options, { arrayMerge: dontMerge })\r\n    this.currentSpec = null\r\n    this.actions = []\r\n    this.overlay = document.createElement('div')\r\n    this.overlay.classList.add(this.options.overlay.className)\r\n    if (this.options.overlay.style) {\r\n      Object.assign(this.overlay.style, this.options.overlay.style)\r\n    }\r\n\r\n    // disable native image resizing on firefox\r\n    document.execCommand('enableObjectResizing', false, 'false') // eslint-disable-next-line-line no-undef\r\n    this.quill.root.addEventListener('click', this.onClick)\r\n    this.specs = this.options.specs.map((SpecClass: any) => new SpecClass(this))\r\n    this.specs.forEach(spec => spec.init())\r\n  }\r\n\r\n  show(spec: BlotSpec) {\r\n    this.currentSpec = spec\r\n    this.currentSpec.setSelection()\r\n    this.setUserSelect('none')\r\n    this.quill.root.parentNode.appendChild(this.overlay)\r\n    this.repositionOverlay()\r\n    this.createActions(spec)\r\n\r\n    // fix: 图片对齐之后，虚线外框应该跟随移动\r\n    const imageDom = spec.getTargetElement()\r\n    const win: any = window\r\n    const MutationObserver = win.MutationObserver || win.WebKitMutationObserver || win.MozMutationObserver\r\n    const element = imageDom.parentNode\r\n    this.observer = new MutationObserver((mutationList) => {\r\n      for (const mutation of mutationList) {\r\n        const target = mutation.target\r\n        const image = target.querySelector('img')\r\n        if (image) {\r\n          this.repositionOverlay()\r\n        }\r\n      }\r\n    })\r\n    this.observer.observe(element, {\r\n      attributes: true,\r\n      attributeFilter: ['class'],\r\n      attributeOldValue: true,\r\n      subtree: true,\r\n    })\r\n    document.body.addEventListener('click', this.hideImageOverlay, true)\r\n  }\r\n\r\n  hide() {\r\n    if (!this.currentSpec) {\r\n      return\r\n    }\r\n\r\n    const imgDom = this.currentSpec.getTargetElement()\r\n    if (imgDom) {\r\n      imgDom.classList.remove('current-select-img')\r\n    }\r\n\r\n    this.currentSpec.onHide()\r\n    this.currentSpec = null\r\n    this.quill.root.parentNode.removeChild(this.overlay)\r\n    this.overlay.style.setProperty('display', 'none')\r\n    this.setUserSelect('')\r\n    this.destroyActions()\r\n  }\r\n\r\n  update() {\r\n    this.repositionOverlay()\r\n    this.actions.forEach(action => action.onUpdate())\r\n  }\r\n\r\n  createActions(spec: BlotSpec) {\r\n    this.actions = spec.getActions().map((ActionClass: any) => {\r\n      const action: Action = new ActionClass(this)\r\n      action.onCreate()\r\n      return action\r\n    })\r\n  }\r\n\r\n  destroyActions() {\r\n    this.actions.forEach((action: Action) => action.onDestroy())\r\n    this.actions = []\r\n  }\r\n\r\n  repositionOverlay() {\r\n    if (!this.currentSpec) {\r\n      return\r\n    }\r\n\r\n    const overlayTarget = this.currentSpec.getOverlayElement()\r\n    if (!overlayTarget) {\r\n      return\r\n    }\r\n\r\n    const parent: HTMLElement = this.quill.root.parentNode\r\n    const specRect = overlayTarget.getBoundingClientRect()\r\n    const parentRect = parent.getBoundingClientRect()\r\n\r\n    Object.assign(this.overlay.style, {\r\n      display: 'block',\r\n      left: `${specRect.left - parentRect.left - 1 + parent.scrollLeft}px`,\r\n      top: `${specRect.top - parentRect.top + parent.scrollTop}px`,\r\n      width: `${specRect.width}px`,\r\n      height: `${specRect.height}px`,\r\n    })\r\n  }\r\n\r\n  setUserSelect(value: string) {\r\n    const props: string[] = [\r\n      'userSelect',\r\n      'mozUserSelect',\r\n      'webkitUserSelect',\r\n      'msUserSelect',\r\n    ]\r\n\r\n    props.forEach((prop: string) => {\r\n      // set on contenteditable element and <html>\r\n      this.quill.root.style.setProperty(prop, value)\r\n      if (document.documentElement) {\r\n        document.documentElement.style.setProperty(prop, value)\r\n      }\r\n    })\r\n  }\r\n\r\n  onClick = () => {\r\n    this.hide()\r\n  }\r\n\r\n  hideImageOverlay = (event) => {\r\n    const target = event.target\r\n    const isBlotFormatter = target?.classList?.contains('blot-formatter__overlay')\r\n    // 点击图片操作框之外应该将其销毁\r\n    if (!isBlotFormatter) {\r\n      this.hide()\r\n    }\r\n    document.body.removeEventListener('click', this.hideImageOverlay)\r\n  }\r\n}\r\n"],"names":["deepmerge","ImageBlot","ImageContainerBlot"],"mappings":"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"}