{"version":3,"file":"CustomResizeAction.es.js","sources":["../../../../src/custom-image/actions/CustomResizeAction.ts"],"sourcesContent":["import Action from './Action'\r\n\r\nconst MIN_WIDTH = 40\r\n\r\nfunction getElementStyle(element) {\r\n  return element.currentStyle\r\n    ? element.currentStyle\r\n    : window.getComputedStyle(element, null)\r\n}\r\nexport default class CustomResizeAction extends Action {\r\n  topLeftHandle: HTMLElement\r\n  topRightHandle: HTMLElement\r\n  bottomRightHandle: HTMLElement\r\n  bottomLeftHandle: HTMLElement\r\n  dragHandle: HTMLElement\r\n  dragStartX: number\r\n  preDragWidth: number\r\n  targetRatio: number\r\n  maxWidth: number\r\n  minWidth: number\r\n\r\n  constructor(formatter) {\r\n    super(formatter)\r\n    this.topLeftHandle = this.createHandle('top-left', 'nwse-resize')\r\n    this.topRightHandle = this.createHandle('top-right', 'nesw-resize')\r\n    this.bottomRightHandle = this.createHandle('bottom-right', 'nwse-resize')\r\n    this.bottomLeftHandle = this.createHandle('bottom-left', 'nesw-resize')\r\n    this.dragHandle = null\r\n    this.dragStartX = 0\r\n    this.preDragWidth = 0\r\n    this.targetRatio = 0\r\n    this.maxWidth = 0\r\n    this.minWidth = MIN_WIDTH\r\n  }\r\n\r\n  onCreate() {\r\n    const target: any = this.formatter.currentSpec.getTargetElement()\r\n    this.formatter.overlay.setAttribute('data-image', target.src)\r\n    this.formatter.overlay.appendChild(this.topLeftHandle)\r\n    this.formatter.overlay.appendChild(this.topRightHandle)\r\n    this.formatter.overlay.appendChild(this.bottomRightHandle)\r\n    this.formatter.overlay.appendChild(this.bottomLeftHandle)\r\n    this.repositionHandles(this.formatter.options.resize.handleStyle)\r\n  }\r\n\r\n  onDestroy() {\r\n    this.setCursor('')\r\n    this.formatter.overlay.removeChild(this.topLeftHandle)\r\n    this.formatter.overlay.removeChild(this.topRightHandle)\r\n    this.formatter.overlay.removeChild(this.bottomRightHandle)\r\n    this.formatter.overlay.removeChild(this.bottomLeftHandle)\r\n  }\r\n\r\n  createHandle(position: string, cursor: string): HTMLElement {\r\n    const box = document.createElement('div')\r\n    box.classList.add(this.formatter.options.resize.handleClassName)\r\n    box.setAttribute('data-position', position)\r\n    box.style.cursor = cursor\r\n\r\n    if (this.formatter.options.resize.handleStyle) {\r\n      Object.assign(box.style, this.formatter.options.resize.handleStyle)\r\n    }\r\n\r\n    box.addEventListener('mousedown', this.onMouseDown)\r\n    return box\r\n  }\r\n\r\n  repositionHandles(handleStyle: any) {\r\n    let handleXOffset = '0px'\r\n    let handleYOffset = '0px'\r\n    if (handleStyle) {\r\n      if (handleStyle.width) {\r\n        handleXOffset = `${-Number.parseFloat(handleStyle.width) / 2}px`\r\n      }\r\n      if (handleStyle.height) {\r\n        handleYOffset = `${-Number.parseFloat(handleStyle.height) / 2}px`\r\n      }\r\n    }\r\n\r\n    Object.assign(this.topLeftHandle.style, { left: handleXOffset, top: handleYOffset })\r\n    Object.assign(this.topRightHandle.style, { right: handleXOffset, top: handleYOffset })\r\n    Object.assign(this.bottomRightHandle.style, { right: handleXOffset, bottom: handleYOffset })\r\n    Object.assign(this.bottomLeftHandle.style, { left: handleXOffset, bottom: handleYOffset })\r\n  }\r\n\r\n  setCursor(value: string) {\r\n    if (document.body) {\r\n      document.body.style.cursor = value\r\n    }\r\n\r\n    if (this.formatter.currentSpec) {\r\n      const target = this.formatter.currentSpec.getOverlayElement()\r\n      if (target) {\r\n        target.style.cursor = value\r\n      }\r\n    }\r\n  }\r\n\r\n  onMouseDown = (event: MouseEvent) => {\r\n    if (!(event.target instanceof HTMLElement)) {\r\n      return\r\n    }\r\n\r\n    this.dragHandle = event.target\r\n    this.setCursor(this.dragHandle.style.cursor)\r\n\r\n    if (!this.formatter.currentSpec) {\r\n      return\r\n    }\r\n\r\n    const target = this.formatter.currentSpec.getTargetElement()\r\n    if (!target) {\r\n      return\r\n    }\r\n    event.preventDefault()\r\n    const rect = target.getBoundingClientRect()\r\n\r\n    this.dragStartX = event.clientX\r\n    this.preDragWidth = rect.width\r\n    this.targetRatio = rect.height / rect.width\r\n\r\n    let root: HTMLElement\r\n    let rootStyle: any\r\n    const tdWrap = this.findTd(target, 0)\r\n    if (tdWrap) {\r\n      root = tdWrap\r\n      rootStyle = getElementStyle(tdWrap)\r\n    }\r\n    else {\r\n      root = this.formatter.quill.root\r\n      rootStyle = getElementStyle(root)\r\n    }\r\n    this.maxWidth = root.clientWidth\r\n    - Number.parseFloat(rootStyle.paddingRight)\r\n    - Number.parseFloat(rootStyle.paddingLeft)\r\n\r\n    document.addEventListener('mousemove', this.onDrag)\r\n    document.addEventListener('mouseup', this.onMouseUp)\r\n  }\r\n\r\n  findTd = (node: HTMLElement, level: number) => {\r\n    if (level > 3) {\r\n      return null\r\n    }\r\n\r\n    const tagName = node.tagName.toUpperCase()\r\n    if (tagName === 'TD') {\r\n      return node\r\n    }\r\n    else {\r\n      const parentNode = node.parentElement\r\n      if (parentNode) {\r\n        return (this.findTd(parentNode, level += 1))\r\n      }\r\n      else {\r\n        return null\r\n      }\r\n    }\r\n  }\r\n\r\n  onDrag = (event: MouseEvent) => {\r\n    if (!this.formatter.currentSpec) {\r\n      return\r\n    }\r\n\r\n    const target = this.formatter.currentSpec.getTargetElement()\r\n    if (!target) {\r\n      return\r\n    }\r\n\r\n    const deltaX = event.clientX - this.dragStartX\r\n    let newWidth = 0\r\n\r\n    if (this.dragHandle === this.topLeftHandle || this.dragHandle === this.bottomLeftHandle) {\r\n      newWidth = Math.round(this.preDragWidth - deltaX)\r\n    }\r\n    else {\r\n      newWidth = Math.round(this.preDragWidth + deltaX)\r\n    }\r\n\r\n    let minWidth = this.minWidth\r\n\r\n    if (this.maxWidth < minWidth) {\r\n      minWidth = this.maxWidth\r\n    }\r\n\r\n    if (newWidth > this.maxWidth) {\r\n      newWidth = this.maxWidth\r\n    }\r\n    else if (newWidth < minWidth) {\r\n      newWidth = minWidth\r\n    }\r\n\r\n    const newHeight = this.targetRatio * newWidth\r\n\r\n    target.setAttribute('width', `${newWidth}`)\r\n    target.setAttribute('height', `${newHeight}`)\r\n\r\n    this.formatter.update()\r\n  }\r\n\r\n  onMouseUp = () => {\r\n    this.setCursor('')\r\n    document.removeEventListener('mousemove', this.onDrag)\r\n    document.removeEventListener('mouseup', this.onMouseUp)\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}