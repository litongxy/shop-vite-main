{"version":3,"file":"file-bar.es.js","sources":["../../../../src/file/modules/file-bar.ts"],"sourcesContent":["import Quill from 'quill'\r\n// devui-internal api: utils\\public-api.ts\r\n\r\nimport { Range } from 'quill/core/selection'\r\nimport { unshiftString } from '../../utils/method'\r\nimport File from '../formats/file'\r\n\r\nconst Delta = Quill.imports.delta\r\n\r\nexport default class FileBar {\r\n  quill: any\r\n  file: any\r\n  domNode: HTMLElement\r\n  fileRange: any\r\n  template: string\r\n\r\n  constructor(quill, target) {\r\n    this.quill = quill\r\n    this.file = target\r\n    const fileBlot = Quill.find(target)\r\n    const index = this.quill.getIndex(fileBlot)\r\n    const [fileItem, offset] = this.quill.scroll.descendant(File, index)\r\n    const length = fileItem && fileItem.length()\r\n    this.fileRange = new Range(index - offset, length)\r\n\r\n    const timestamp = Number(this.file.dataset.lastModified)\r\n    const _lastModifiedDate = this.formatDate(timestamp)\r\n    this.template = [\r\n      // `<a class=\"ql-last-modified-date\" href=\"${this.file.href}\" target=\"_blank\">${this.file.href}</a>`,\r\n      // '<span class=\"ql-split\"></span>',\r\n      // `<a class=\"ql-file-preview\"><i class=\"icon-preview\"></i></a>`,\r\n      `<a class=\"ql-file-download\"><i class=\"icon-download\"></i></a>`,\r\n      '<a class=\"ql-file-delete\"><i class=\"icon-delete\"></i></a>',\r\n    ].join('')\r\n\r\n    this.createFileBar()\r\n  }\r\n\r\n  createFileBar() {\r\n    this.domNode = document.createElement('div')\r\n    this.domNode.className = 'ql-file-bar'\r\n    this.domNode.innerHTML = this.template\r\n    // 查看文件\r\n    const filePreview = this.domNode.querySelector('a.ql-file-preview')\r\n    if (filePreview) {\r\n      filePreview.addEventListener('click', (event) => {\r\n        this.operateFile(event, 'view')\r\n      })\r\n    }\r\n    // 下载文件\r\n    const fileDownload = this.domNode.querySelector('a.ql-file-download')\r\n    if (fileDownload) {\r\n      fileDownload.addEventListener('click', (event) => {\r\n        this.operateFile(event, 'download')\r\n      })\r\n    }\r\n    // 删除文件\r\n    const fileDelete = this.domNode.querySelector('a.ql-file-delete')\r\n    if (fileDelete) {\r\n      fileDelete.addEventListener('click', (event) => {\r\n        this.operateFile(event, 'delete')\r\n        const delta = new Delta()\r\n          .retain(this.fileRange.index)\r\n          .delete(this.fileRange.length)\r\n        this.quill.updateContents(delta, Quill.sources.USER)\r\n        this.quill.setSelection(this.fileRange.index)\r\n      })\r\n    }\r\n\r\n    this.setPosition()\r\n    this.quill.root.parentNode.appendChild(this.domNode)\r\n  }\r\n\r\n  destroy() {\r\n    if (this.domNode) {\r\n      this.domNode.remove()\r\n      this.domNode = null\r\n      this.file = null\r\n    }\r\n  }\r\n\r\n  operateFile(event, operate) {\r\n    event.preventDefault()\r\n    const fileId = this.file.dataset.id || ''\r\n    const fileDownloadUrl = this.file.href\r\n    if (fileId) {\r\n      this.quill.emitter.emit('file-change', {\r\n        operation: operate,\r\n        data: { fileId, fileDownloadUrl },\r\n      })\r\n    }\r\n    if (operate === 'download') {\r\n      const a = document.createElement('a')\r\n      a.href = fileDownloadUrl\r\n      a.target = '_blank'\r\n      a.id = 'exppub'\r\n      document.body.appendChild(a)\r\n      const alink = document.getElementById('exppub')\r\n      alink.click()\r\n      alink.parentNode.removeChild(a)\r\n    }\r\n    this.destroy()\r\n  }\r\n\r\n  setPosition() {\r\n    if (this.domNode && this.file) {\r\n      const parent = this.quill.root.parentNode\r\n      const child = this.file.querySelector('span')\r\n      const containerRect = parent.getBoundingClientRect()\r\n      const fileRect = child.getBoundingClientRect()\r\n      this.css(this.domNode, {\r\n        left: `${fileRect.left - containerRect.left}px`,\r\n        top: `${fileRect.top - containerRect.top + 10}px`,\r\n      })\r\n    }\r\n  }\r\n\r\n  css(domNode, rules) {\r\n    if (typeof rules === 'object') {\r\n      for (const prop in rules) {\r\n        if (prop) {\r\n          if (Array.isArray(rules[prop])) {\r\n            // 兼容IE11浏览器\r\n            rules[prop].forEach((val) => {\r\n              domNode.style[prop] = val\r\n            })\r\n          }\r\n          else {\r\n            domNode.style[prop] = rules[prop]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  formatDate(timestamp) {\r\n    const date = new Date(timestamp)\r\n    const year = date.getFullYear()\r\n    // TODO\r\n    const month = unshiftString(`${date.getMonth() + 1}`, 2, '0')\r\n    const day = unshiftString(`${date.getDate()}`, 2, '0')\r\n    const hour = unshiftString(`${date.getHours()}`, 2, '0')\r\n    const minute = unshiftString(`${date.getMinutes()}`, 2, '0')\r\n    return Number.isNaN(year) ? '--' : `${year}/${month}/${day} ${hour}:${minute}`\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}