{"version":3,"file":"fluent-editor.es.js","sources":["../../src/fluent-editor.ts"],"sourcesContent":["import type { ExpandedQuillOptions, Module, Parchment as TypeParchment } from 'quill'\r\nimport type { IEditorConfig } from './config/types'\r\nimport Quill from 'quill'\r\nimport { FontStyle, LineHeightStyle, SizeStyle, TextIndentStyle } from './attributors'\r\nimport { CHANGE_LANGUAGE_EVENT, defaultLanguage, getListValue, ICONS_CONFIG, inputFile, LANG_CONF } from './config'\r\nimport Counter from './counter' // 字符统计\r\nimport CustomClipboard from './custom-clipboard' // 粘贴板\r\nimport CustomImage from './custom-image/BlotFormatter' // 图片\r\nimport { CustomImageSpec } from './custom-image/specs/CustomImageSpec' // 图片拉伸模块\r\nimport CustomUploader from './custom-uploader' // 上传\r\nimport Emoji from './emoji' // 表情\r\nimport FileModule from './file' // 文件\r\nimport { FormatPainter } from './format-painter'\r\nimport { fullscreenHandler } from './fullscreen/handler'\r\nimport Link from './link' // 超链接\r\nimport MathliveModule from './mathlive' // latex公式\r\nimport MathliveBlot from './mathlive/formats'\r\nimport Mention from './mention/Mention' // @提醒\r\nimport { Screenshot } from './screenshot'// 截图\r\nimport SoftBreak from './soft-break' // 软回车\r\nimport Strike from './strike' // 删除线\r\nimport CustomSyntax from './syntax' // 代码块高亮\r\nimport BetterTable from './table/better-table' // 表格\r\nimport Toolbar, { ToolbarTip } from './toolbar' // 工具栏\r\nimport { isUndefined } from './utils/is'\r\nimport Video from './video' // 视频\r\n// import GlobalLink from './global-link' // 全局链接\r\n// import QuickMenu from './quick-menu' // 快捷菜单\r\nexport interface I18NOptions {\r\n  lang: string\r\n  langText: Record<string, string>\r\n}\r\nfunction resolveLanguageOption(options: Partial<I18NOptions>): I18NOptions {\r\n  if (isUndefined(options.lang)) {\r\n    options.lang = defaultLanguage\r\n  }\r\n  if (!(options.lang in LANG_CONF)) {\r\n    console.warn(`The language ${options.lang} is not supported. Use the default language: ${defaultLanguage}`)\r\n    options.lang = defaultLanguage\r\n  }\r\n  return {\r\n    lang: options.lang,\r\n    langText: Object.assign({}, LANG_CONF[options.lang], options.langText || {}),\r\n  }\r\n}\r\nexport class FluentEditor extends Quill {\r\n  isFullscreen: boolean = false\r\n  options: IEditorConfig & ExpandedQuillOptions\r\n  constructor(container: HTMLElement | string, options: IEditorConfig = {}) {\r\n    options = Object.assign(options, resolveLanguageOption(options || {}))\r\n    super(container, options)\r\n  }\r\n\r\n  changeLanguage(options: Partial<I18NOptions>) {\r\n    const langOps = resolveLanguageOption(options)\r\n    if (langOps.lang === this.options.lang) return\r\n    this.options.lang = langOps.lang\r\n    this.options.langText = langOps.langText\r\n    this.emitter.emit(CHANGE_LANGUAGE_EVENT, this.options.lang, this.options.langText)\r\n  }\r\n}\r\n\r\nconst registerModules = function () {\r\n  const Icons = Quill.import('ui/icons')\r\n  Object.entries(ICONS_CONFIG).forEach(([key, icon]) => {\r\n    Icons[key] = icon\r\n  })\r\n\r\n  const SnowTheme = Quill.imports['themes/snow'] as typeof Module\r\n  SnowTheme.DEFAULTS = {\r\n    modules: {\r\n      'keyboard': {\r\n        bindings: {\r\n          ...BetterTable.keyboardBindings,\r\n        },\r\n      },\r\n      'toolbar': {\r\n        handlers: {\r\n          ...(SnowTheme.DEFAULTS as Record<string, any>).modules.toolbar.handlers,\r\n          'formula': function () {\r\n            if (!this.quill.isEnabled()) return\r\n            const mathlive = this.quill.getModule('mathlive')\r\n            if (!mathlive) {\r\n              this.quill.theme.tooltip.edit('formula')\r\n            }\r\n            else {\r\n              mathlive.createDialog()\r\n            }\r\n          },\r\n          'undo': function () {\r\n            this.quill.history.undo()\r\n          },\r\n          'redo': function () {\r\n            this.quill.history.redo()\r\n          },\r\n          'better-table': function () {\r\n            this.quill.getModule('better-table').insertTable(3, 3)\r\n          },\r\n          'file': function () {\r\n            const accept = this.quill.options?.uploadOption?.fileAccept\r\n            inputFile.call(this, 'file', accept)\r\n          },\r\n          'image': function () {\r\n            const accept = this.quill.options?.uploadOption?.imageAccept\r\n            inputFile.call(this, 'image', accept)\r\n          },\r\n          'emoji': function () {},\r\n          'fullscreen': fullscreenHandler,\r\n          'list': function (value) {\r\n            const range = this.quill.getSelection()\r\n            const formats = this.quill.getFormat(range)\r\n            const preListValue = Array.isArray(formats.list) ? formats.list[0]?.value : formats.list?.value\r\n            const curListValue = getListValue(value, preListValue)\r\n            // 如果设置list的选区中有表格，判断第一个table-col位置，将表格前的内容设置为list格式\r\n            const lines = this.quill.getLines(range.index, range.length)\r\n            const tableCols = lines.filter(line => line.statics.blotName === 'table-col' && !line.prev)\r\n            if (tableCols.length) {\r\n              let start = range.index\r\n              // 遍历table-col群组，以之获取表格，将表格前选区设置为对应list格式\r\n              tableCols.forEach((item, index) => {\r\n                const table = item.domNode.closest('table.quill-better-table')\r\n                const tableBlot = Quill.find(table) as TypeParchment.Blot\r\n                const tableLength = tableBlot.length()\r\n                const tableStart = this.quill.getIndex(item)\r\n                const tableEnd = tableStart + tableLength\r\n                const beforeTableRangeLength = tableStart - start\r\n                // 在表格前设置列表\r\n                this.quill.setSelection(start, beforeTableRangeLength, Quill.sources.SILENT)\r\n                this.quill.format('list', curListValue, Quill.sources.USER)\r\n                table.parentNode.classList.remove('quill-better-table-selected')\r\n                // 当前表格末尾为下一个选取的开始\r\n                start = tableEnd\r\n                if (index === tableCols.length - 1) {\r\n                  // 将最后一个表格之后所有选区内容设置list格式\r\n                  this.quill.setSelection(tableEnd, range.index + range.length - tableEnd)\r\n                  this.quill.format('list', curListValue, Quill.sources.USER)\r\n                }\r\n              })\r\n            }\r\n            else {\r\n              this.quill.format('list', curListValue, Quill.sources.USER)\r\n            }\r\n          },\r\n          [FormatPainter.toolName]: FormatPainter,\r\n          [Screenshot.toolName]: Screenshot,\r\n          'lineheight': function (value) {\r\n            this.quill.format('line-height', value)\r\n          },\r\n        },\r\n      },\r\n      'better-table': {\r\n        operationMenu: {\r\n          color: true,\r\n        },\r\n      },\r\n      'image': {\r\n        specs: [CustomImageSpec],\r\n        overlay: {\r\n          style: {\r\n            border: '1px dashed rgb(68, 68, 68)',\r\n          },\r\n        },\r\n        align: {\r\n          icons: {\r\n            left: '<i class=\"icon-text-align-left\"></i>',\r\n            center: '<i class=\"icon-text-align-center\"></i>',\r\n            right: '<i class=\"icon-text-align-right\"></i>',\r\n          },\r\n        },\r\n      },\r\n      [ToolbarTip.moduleName]: true,\r\n    },\r\n  }\r\n\r\n  FluentEditor.register(\r\n    {\r\n      'modules/toolbar': Toolbar,\r\n      'modules/mention': Mention,\r\n      'modules/better-table': BetterTable,\r\n      'modules/clipboard': CustomClipboard,\r\n      'modules/uploader': CustomUploader, // 三者关联性最强\r\n      'modules/image': CustomImage, // 三者关联性最强\r\n      'modules/file': FileModule, // 三者关联性最强\r\n      'modules/counter': Counter,\r\n      'modules/emoji-toolbar': Emoji.ToolbarEmoji,\r\n      'modules/emoji-shortname': Emoji.ShortNameEmoji,\r\n      // 'modules/global-link': GlobalLink,//暂未开发\r\n      'modules/link': Link, // 报错\r\n      // 'modules/quickmenu': QuickMenu,//暂未开发\r\n      'modules/syntax': CustomSyntax,\r\n      'modules/mathlive': MathliveModule,\r\n      [`modules/${ToolbarTip.moduleName}`]: ToolbarTip,\r\n\r\n      'formats/strike': Strike,\r\n      'formats/softBreak': SoftBreak,\r\n      'formats/video': Video,\r\n      'formats/emoji': Emoji.EmojiBlot,\r\n      'formats/font': FontStyle,\r\n      'formats/size': SizeStyle,\r\n      'formats/line-height': LineHeightStyle,\r\n      'formats/text-indent': TextIndentStyle,\r\n      [`formats/${MathliveBlot.blotName}`]: MathliveBlot,\r\n    },\r\n    true, // 覆盖内部模块\r\n  )\r\n\r\n  return FluentEditor\r\n}\r\n\r\nexport default registerModules()\r\n"],"names":["Toolbar","CustomImage","Strike"],"mappings":"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"}