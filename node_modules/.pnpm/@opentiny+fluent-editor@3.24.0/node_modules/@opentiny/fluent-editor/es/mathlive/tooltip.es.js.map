{"version":3,"file":"tooltip.es.js","sources":["../../../src/mathlive/tooltip.ts"],"sourcesContent":["import type { MathfieldElement } from 'mathlive'\r\nimport type { Bounds } from 'quill/core/selection'\r\nimport type TypeTooltip from 'quill/ui/tooltip'\r\nimport Quill from 'quill'\r\n\r\nconst Delta = Quill.import('delta')\r\nconst Tooltip = Quill.import('ui/tooltip') as typeof TypeTooltip\r\nexport default class MathliveTooltip extends Tooltip {\r\n  static TEMPLATE = ``\r\n\r\n  mathliveDom: MathfieldElement\r\n  editValue?: string\r\n\r\n  constructor(quill: Quill, boundsContainer?: HTMLElement) {\r\n    super(quill, boundsContainer)\r\n    this.mathliveDom = document.createElement('math-field') as MathfieldElement\r\n    this.mathliveDom.classList.add('ql-math-field')\r\n    this.root.appendChild(this.mathliveDom)\r\n    this.root.classList.add('math-field-tooltip')\r\n    this.listen()\r\n  }\r\n\r\n  listen() {\r\n    this.mathliveDom.addEventListener('blur', (event) => {\r\n      this.hide()\r\n    })\r\n    this.root.addEventListener('keydown', (event) => {\r\n      if (event.key === 'Enter') {\r\n        event.preventDefault()\r\n        this.save()\r\n      }\r\n      else if (event.key === 'Escape') {\r\n        event.preventDefault()\r\n        this.cancel()\r\n      }\r\n    })\r\n  }\r\n\r\n  cancel() {\r\n    this.hide()\r\n    this.restoreFocus()\r\n  }\r\n\r\n  edit(value?: string) {\r\n    this.editValue = value\r\n    this.root.classList.remove('ql-hidden')\r\n    this.root.classList.add('ql-editing')\r\n    this.mathliveDom.setValue(value || '')\r\n    const range = this.quill.getSelection()\r\n    const bounds = range ? this.quill.getBounds(range) : null\r\n    if (bounds != null) {\r\n      this.position(bounds)\r\n    }\r\n    this.show()\r\n    this.mathliveDom.focus()\r\n  }\r\n\r\n  restoreFocus() {\r\n    this.mathliveDom.blur()\r\n    this.quill.focus({ preventScroll: true })\r\n  }\r\n\r\n  save() {\r\n    const range = this.quill.getSelection(true)\r\n    const inputValue = this.mathliveDom.value\r\n    if (!inputValue) return\r\n    const index = range ? range.index : this.quill.getLength() - 1\r\n    const delta = new Delta()\r\n      .retain(index)\r\n      .delete(this.editValue ? 1 : range?.length || 0)\r\n      .insert({ mathlive: { value: inputValue, mode: 'dialog' } })\r\n    this.quill.updateContents(delta, Quill.sources.USER)\r\n    this.quill.setSelection(index + 1, Quill.sources.SILENT)\r\n    this.hide()\r\n  }\r\n\r\n  position(reference: Bounds) {\r\n    const adjustedReference = { ...reference }\r\n    adjustedReference.left = reference.left + this.root.offsetWidth / 2 - reference.width / 2\r\n    return super.position(adjustedReference)\r\n  }\r\n}\r\n"],"names":[],"mappings":";AAKA,MAAM,QAAQ,MAAM,OAAO,OAAO;AAClC,MAAM,UAAU,MAAM,OAAO,YAAY;AACzC,MAAqB,mBAArB,MAAqB,yBAAwB,QAAQ;AAAA,EAMnD,YAAY,OAAc,iBAA+B;AACvD,UAAM,OAAO,eAAe;AACvB,SAAA,cAAc,SAAS,cAAc,YAAY;AACjD,SAAA,YAAY,UAAU,IAAI,eAAe;AACzC,SAAA,KAAK,YAAY,KAAK,WAAW;AACjC,SAAA,KAAK,UAAU,IAAI,oBAAoB;AAC5C,SAAK,OAAO;AAAA,EACd;AAAA,EAEA,SAAS;AACP,SAAK,YAAY,iBAAiB,QAAQ,CAAC,UAAU;AACnD,WAAK,KAAK;AAAA,IAAA,CACX;AACD,SAAK,KAAK,iBAAiB,WAAW,CAAC,UAAU;AAC3C,UAAA,MAAM,QAAQ,SAAS;AACzB,cAAM,eAAe;AACrB,aAAK,KAAK;AAAA,MAAA,WAEH,MAAM,QAAQ,UAAU;AAC/B,cAAM,eAAe;AACrB,aAAK,OAAO;AAAA,MACd;AAAA,IAAA,CACD;AAAA,EACH;AAAA,EAEA,SAAS;AACP,SAAK,KAAK;AACV,SAAK,aAAa;AAAA,EACpB;AAAA,EAEA,KAAK,OAAgB;AACnB,SAAK,YAAY;AACZ,SAAA,KAAK,UAAU,OAAO,WAAW;AACjC,SAAA,KAAK,UAAU,IAAI,YAAY;AAC/B,SAAA,YAAY,SAAS,SAAS,EAAE;AAC/B,UAAA,QAAQ,KAAK,MAAM,aAAa;AACtC,UAAM,SAAS,QAAQ,KAAK,MAAM,UAAU,KAAK,IAAI;AACrD,QAAI,UAAU,MAAM;AAClB,WAAK,SAAS,MAAM;AAAA,IACtB;AACA,SAAK,KAAK;AACV,SAAK,YAAY;EACnB;AAAA,EAEA,eAAe;AACb,SAAK,YAAY;AACjB,SAAK,MAAM,MAAM,EAAE,eAAe,KAAM,CAAA;AAAA,EAC1C;AAAA,EAEA,OAAO;AACL,UAAM,QAAQ,KAAK,MAAM,aAAa,IAAI;AACpC,UAAA,aAAa,KAAK,YAAY;AACpC,QAAI,CAAC,WAAY;AACjB,UAAM,QAAQ,QAAQ,MAAM,QAAQ,KAAK,MAAM,UAAc,IAAA;AACvD,UAAA,QAAQ,IAAI,MAAA,EACf,OAAO,KAAK,EACZ,OAAO,KAAK,YAAY,KAAI,+BAAO,WAAU,CAAC,EAC9C,OAAO,EAAE,UAAU,EAAE,OAAO,YAAY,MAAM,SAAS,EAAA,CAAG;AAC7D,SAAK,MAAM,eAAe,OAAO,MAAM,QAAQ,IAAI;AACnD,SAAK,MAAM,aAAa,QAAQ,GAAG,MAAM,QAAQ,MAAM;AACvD,SAAK,KAAK;AAAA,EACZ;AAAA,EAEA,SAAS,WAAmB;AACpB,UAAA,oBAAoB,EAAE,GAAG;AACb,sBAAA,OAAO,UAAU,OAAO,KAAK,KAAK,cAAc,IAAI,UAAU,QAAQ;AACjF,WAAA,MAAM,SAAS,iBAAiB;AAAA,EACzC;AACF;AAzEE,iBAAO,WAAW;AADpB,IAAqB,kBAArB;"}